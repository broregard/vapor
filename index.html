<!DOCTYPE html>
<html lang="en" >

<head>

  <meta charset="UTF-8">
  <title>Vaporwave Audio Visualizer </title>
  
  
  
  
      <style>
      body {
  overflow: hidden;
  margin: 0;
  background: linear-gradient(#07279b,#000,#000);
  background-size: 8px 8px;
}
button {
  font-family:monospace;
  background-color: black;
  border:green;
  color: magenta;
  font-size: 20px;
  z-index: 1;
  display: inline;
}
.btn-container {
  position: absolute;
  bottom: 0;
  display: flex;
  width: 100%;
  background: black;
  color: white;
}
.overlay {
  position: absolute;
  height: 100vh;
  width: 100vw;
  top: 0; left: 0;
  display: none;
  align-items: center;
  justify-content: center;
  font-family: sans-serif;
  color: rgba(255,255,255,1);
}
        
    </style>

  
  
  
  

</head>

<body translate="no" >
<div class="overlay"><h1>Click anywhere to play</h1></div>
  <div class="bg"></div>


<div class="btn-container">
  <audio controls></audio>
  <input class="input-file" type="file" id="file" accept="audio/*"/>
</div>
  
  <script src='https://cdnjs.cloudflare.com/ajax/libs/three.js/92/three.min.js'></script>
<script src='https://dl.dropboxusercontent.com/s/68s49o4j3jpjb1s/OrbitControls.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.2/dat.gui.min.js'></script>

  

    <script >
      var viz;

const playlist = {
  "golden gal": "https://dl.dropboxusercontent.com/s/4li5qc35oiqm8sf/goldengal.mp3",
  "floridada": "https://dl.dropboxusercontent.com/s/szgt5guo7lopubc/FloriDada.mp3"
};

var VizCtrl = function() {
  this.song = "";
  this.spread = 3;
  this.width = 40;
  this.sphereFrequency = 10;
  this.limit = 110;
  this.animSphere = true;
  this.animWave = true;
  this.animCrunch = true;
  this.resetPlane = () => {
       for (let x = 0; x < o.geometry.vertices.length; x++) {
        let v = o.geometry.vertices[x];
         v.x = initVerts[x];
         v.z = 0;
      }  
      o.geometry.computeFaceNormals();	
      o.geometry.normalsNeedUpdate = true;  
      o.geometry.verticesNeedUpdate = true;
  }
};


  viz = new VizCtrl();

  var gui = new dat.GUI();
  gui.add(viz, "song", playlist).onChange(fetchSong);
  gui.add(viz, 'sphereFrequency', 0, 40).step(1)
  gui.add(viz, 'spread', 1, 10).step(1)
  gui.add(viz, 'width', 10, 80).step(1)
  gui.add(viz, 'limit', 10, 200).step(1)
  gui.add(viz, 'animSphere')
  gui.add(viz, 'animWave')
  gui.add(viz, 'animCrunch')
  gui.add(viz, "resetPlane")
  gui.close();



//////////////////////////////////////////////////////
// Set up scene
let scene = new THREE.Scene();
let renderer = new THREE.WebGLRenderer({alpha: true,antialias:true});
let camera = new THREE.PerspectiveCamera(
  75, window.innerWidth / window.innerHeight, 0.1, 1000
);
scene.add(camera);
camera.rotation.x = Math.PI/180*90

renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild( renderer.domElement );

var controls = new THREE.OrbitControls(camera, renderer.domElement);

//////////////////////////////////////////////////////
// on window resize
window.addEventListener('resize', onWindowResize, false);

function onWindowResize(){
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}


//////////////////////////////////////////////////////
// btn fx stuff
let o, o1, l1, circle,
    counter = 0,planeCounter = 0, increase = .06;

let initVerts = [];



//////////////////////////////////////////////////////
// audio stuff
const audio = document.querySelector("audio");
const vert = [];
const url = "https://dl.dropboxusercontent.com/s/4li5qc35oiqm8sf/goldengal.mp3";
const overlay = document.querySelector(".overlay");
      
function fetchSong() {
  fetch(viz.song).then(mp3 => mp3.blob()).then(mp3 => {
    audio.pause();
    overlay.style.display = "flex";
    window.addEventListener("click", function allowAudio() {
      window.removeEventListener("click", allowAudio);
      overlay.style.display = "none";
      doMusic(mp3);
    })
  });
}



file.onchange = function() {
  doMusic(this.files[0]);
}

function clamp(num, min, max) {
  return num <= min ? min : num >= max ? max : num;
}

function doMusic(mp3) {
  let audioContext = window.webkitAudioContext || window.AudioContext;
  let files = this.files;
  
  audio.src = URL.createObjectURL(mp3);
  audio.load();
  audio.play();
  
  let context = new audioContext();
  let src = context.createMediaElementSource(audio);
  let analyser = context.createAnalyser();

  src.connect(analyser);
  analyser.connect(context.destination);

  let bufferLength = analyser.frequencyBinCount;
  let frequencyData = new Uint8Array(bufferLength);

  createScene()

  function createScene(){
    createPlane();
    createCircle();
    createLight();
  }

  function createPlane() {
    let g = new THREE.PlaneGeometry(200,200,40,40);
    let m = new THREE.MeshStandardMaterial({flatShading:1,
                                            wireframe:1,
                                            color:0x06414c,
                                            emissive: 0x03223d,
                                            emissiveIntensity:.8,
                                            metalness:.9,
                                            roughness:.5});
    o = new THREE.Mesh(g,m);
    o.rotation.x = Math.PI * 270 / 180;
    o.position.y = -5;
    scene.add(o);

 
    // Distort plane
    for (let x = 0; x < o.geometry.vertices.length; x++) {
      let v = o.geometry.vertices[x];
      let distanceFromCenterY = Math.abs(v.x)/100;

      v.z += distanceFromCenterY > .2 ? 
        (Math.random() * (20 - .15) + .15) * distanceFromCenterY*2 : 
      ((Math.random() * (.8 - .2) + .2) + distanceFromCenterY);

      vert[x] = v;
      initVerts[x] = v.x;
    }

    //create separate wireframe
    let wireframe = o.clone();
    wireframe.material = new THREE.MeshBasicMaterial({wireframe:true,
                                                      color:0x00ffff});
    scene.add(wireframe)
    wireframe.scale.multiplyScalar(1.001);
  }

  function createCircle() {
    let g1 = new THREE.SphereGeometry( 22, 20, 20 );
    let m1 = new THREE.MeshBasicMaterial( { color: 0xff00ff,wireframe:false } );
    o1 = new THREE.Mesh( g1, m1 );
    o1.position.z = -130;
    scene.add( o1 );

    camera.position.z = -20;
    controls.target.set(0,0,-100)
    controls.update();
  }

  function createLight() {
    l1 = new THREE.SpotLight( 0xff00ff ,5,150,10,0,2);
    let l2 = new THREE.HemisphereLight( 0x000000, 0xffffff, 1 );
    let l3 = new THREE.PointLight( 0xff00ff,.6, 250 );

    l1.position.set( 0, 50, -130 );
    l1.lookAt(o1)

    l3.position.set(0, 50, -150 );

    scene.add(l1)
    scene.add( l2 );
    scene.add( l3 );
  }

  function visualize() {
    analyser.getByteFrequencyData(frequencyData);

    if (viz.animSphere || viz.animWave || viz.animCrunch ) {

      avg = frequencyData[viz.sphereFrequency]/200 ;
      avg *= avg;

      viz.animSphere ? (o1.scale.set(avg+.001,avg+.001,avg+.001),
            l1.intensity = avg*avg*20) : 0;

      planeSine = Math.sin(planeCounter);
      let f1 = frequencyData[1]

      for (let x = 0; x < o.geometry.vertices.length; x++) {
        let v = o.geometry.vertices[x];

        viz.animWave ? v.z = 1 + Math.abs(Math.sin( (v.z) / viz.width ) * (frequencyData[Math.floor(x/viz.spread)] * (vert[x].x/100) * 2 - 2)) / 3 : 0;
        
        v.z = clamp (v.z, 0, viz.limit)
       
        viz.animCrunch ? v.x += Math.sin(planeCounter) * (f1)*.00005  * v.x : 0;

      }  
      o.geometry.computeFaceNormals();	
      o.geometry.normalsNeedUpdate = true;  
      o.geometry.verticesNeedUpdate = true;

      counter += increase;
    }
    planeCounter += .06;
  }

  //////////////////////////////////////////////////////
  // Render it
  let count = 1;
  let countInterval = Math.PI / 250; 

  
  function render() {
    let sin = Math.sin(count * .55) * .6;
    camera.translateZ(sin);


    
    count += countInterval;
    visualize()
    requestAnimationFrame(render);
    renderer.render(scene, camera);
  }
  render();
}
    </script>
</body>
</html>
